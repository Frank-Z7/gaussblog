**+++**<br />**title="openGauss社区入门(opengauss-事务管理小结)"**<br />**date="2022-08-11"**<br />**tags=["openGauss社区开发入门"]**<br />**archives=“2022-08”**<br />**author=“wangrururu”**<br />**summary="openGauss社区开发入门"**<br />**img="/zh/post/wzr/title/title.jpg"**<br />**times="10:06"**<br />**+++**

**1.事务概念：**<br />	在日常操作中，对于一组相关操作通常需要其全部成功或全部失败，在关系型数据库中，这组相关操作称为事务。<br />**2.事务特性：**<br />	**原子性**（atomicity，A）：事务必须以一个整体单元的形式工作，对于其数据的修改，要么全部执行，幺要么全都不执行。如果只执行事务中多个操作的前半部分就会出现错误，那么必须回滚所有操作，让数据在逻辑上回滚到先前的状态。<br />	**一致性**(consistency，C)：事务在完成时，必须使所有的数据都保持一致状态。<br />	**隔离性**（isolation，I）：事务查看数据时数据所处的状态，要么是零一并发事务修改它之前的状态，要么是另一事务修改它之后的状态，事务是不会查看中间状态的数据的。<br />	**持久性**（durability，D）：事务完成之后，对于系统的影响是永久性的。即使今后出现致命的系统故障，数据也将一直保持。<br />**3. 事务的隔离级别**<br />	openGauss支持的事务隔离级别有两个：<br />	**Read Committed**（读提交）：只有在事务提交后，其更新结果才会被其他事务看见。可以解决脏读问题。<br />	**Repeateble Read**（重复读）：在一个事务中，对于同一份数据的读取结果总是相同的，无论是否有其他事务对这份数据进行操作，以及这个事务是否提交。可以解决脏读、不可重复读。<br />**4.事务语法参数：**<br />（1）**transaction_isolation**：设置当前事务的隔离级别。<br />	取值范围：字符串，只识别以下字符串，大小写空格敏感：<br />		serializable：等价于REPEATABLE READ。<br />		read committed：只能读取已提交的事务的数据（缺省），不能读取到未提交的数据。<br />		repeatable read：仅能读取事务开始之前提交的数据，不能读取未提交的数据以及在事务执行期间由		其它并发事务提交的修改。<br />		default：设置为default_transaction_isolation所设隔离级别。<br />	默认值：read committed<br />（2）**transaction_read_only**：设置当前事务是只读事务。该参数在数据库恢复过程中/在备机里固定为on；否则为default_transaction_read_only的值。<br />	取值范围：布尔型<br />		on表示设置当前事务为只读事务。<br />		off表示该事务可以是非只读事务。<br />	默认值：off<br />（3）**xc_maintenance_mode**：设置系统进入维护模式。（谨慎打开这个开关，避免引起openGauss数据不一致）<br />	取值范围：布尔型<br />		on表示该功能启用。<br />		off表示该功能被禁用。<br />	默认值：off<br />（4）**allow_concurrent_tuple_update**：设置是否允许并发更新。<br />	取值范围：布尔型<br />		on表示该功能启用。<br />		off表示该功能被禁用。<br />	默认值：on<br />（5）**transaction_deferrable**：指定是否允许一个只读串行事务延迟执行，使其不会执行失败。<br />	取值范围：布尔型<br />		on表示允许执行。<br />		off表示不允许执行。<br />	默认值：off<br />（6）**enable_show_any_tuples**：该参数只有在只读事务中可用，用于分析。<br />	取值范围：布尔型<br />		on/true表示表中元组的所有版本都会可见。<br />		off/false表示表中元组的所有版本都不可见。<br />	默认值：off<br />（7）**replication_type**：标记当前HA模式是单主机模式、主备从模式还是一主多备模式。该参数用户不能自己去设置参数值。<br />	取值范围：0~2<br />		2 表示单主机模式，此模式无法扩展备机。<br />		1 表示使用一主多备模式，全场景覆盖，推荐使用。<br />		0 表示主备从模式，目前此模式暂不支持。<br />	默认值：1<br />（8）**pgxc_node_name**：指定节点名称。在备机请求主机进行日志复制时，如果application_name参数没有被设置，那么pgxc_node_name参数会被用来作为备机在主机上的流复制槽名字。该流复制槽的命名方式为 "该参数值_备机ip_备机port"。其中，备机ip和备机port取自replconninfo参数中指定的备机ip和端口号。该流复制槽最大长度为61个字符，如果拼接后的字符串超过该长度，则会使用截断后的pgxc_node_name进行拼接，以保证流复制槽名字长度小于等于61个字符。此参数修改后会导致连接数据库实例失败，不建议进行修改。<br />	取值范围：字符串<br />	默认值：当前节点名称<br />（9）**enable_defer_calculate_snapshot**：延迟计算快照的xmin和oldestxmin，执行1000个事务或者间隔1s才触发计算，设置为on时可以在高负载场景下减少计算快照的开销，但是会导致oldestxmin推进较慢，影响垃圾元组回收，设置为off时xmin和oldestxmin可以实时推进，但是会增加计算快照时的开销。<br />	取值范围：布尔型。<br />		on表示延迟计算快照xmin和oldestxmin。<br />		off表示实时计算快照xmin和oldestxmin。<br />	默认值：on。<br />**5.自治事务**<br />	在主事务执行过程中新启的独立的事务。自治事务的提交和回滚不会影响主事务已提交的数据，同时自治事务也不受主事务影响。自治事务在存储过程、函数和匿名块中定义，用PRAGMA AUTONOMOUS_TRANSACTION关键字来声明。<br />例如存储过程中含自治事务：<br />--建表<br />create table t2(a int, b int);<br />insert into t2 values(1,2);<br />select * from t2;<br />--创建包含自治事务的存储过程<br />CREATE OR REPLACE PROCEDURE autonomous_4(a int, b int)  AS<br />DECLARE<br />num3 int := a;<br />num4 int := b;<br />PRAGMA AUTONOMOUS_TRANSACTION;<br />BEGIN<br />insert into t2 values(num3, num4);<br />END;<br />/<br />--创建调用自治事务存储过程的普通存储过程<br />CREATE OR REPLACE PROCEDURE autonomous_5(a int, b int)  AS<br />DECLARE<br />BEGIN<br />insert into t2 values(666, 666);<br />autonomous_4(a,b);<br />rollback;<br />END;<br />/<br />--调用普通存储过程<br />select autonomous_5(11,22);<br />--查看表结果<br />select * from t2 order by a;<br />结果为：**主事务的回滚，不会影响自治事务已经提交的内容**。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/32435345/1660125046688-639e17e6-4b7c-44fc-a2ed-e3e912d89862.png#clientId=ufa95ed29-d1f0-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=102&id=u33d53ed8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=127&originWidth=310&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26237&status=done&style=none&taskId=ub4c309b7-988c-4de2-a59e-7c8390fb9e3&title=&width=248)
